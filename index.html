<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Powersat Service Ticket Editor</title>


<!-- Librerías para exportar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{ --accent:#0b63d8; --muted:#444; --card:#fff; }
  body{font-family:Arial, Helvetica, sans-serif; background:#f3f5f8; margin:16px; color:#111;}
  .container{display:flex; gap:18px; align-items:flex-start;}
  .panel{background:var(--card); padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06);}

  .panel.preview-wrap{
    padding:0;
    border:none;
    box-shadow:none;
  }

  .form{width:380px; max-height:86vh; overflow:auto;}
  label{display:block; margin-top:10px; font-size:15px; color:var(--muted);}

  input[type="text"], input[type="time"], input[type="date"], select, textarea{
    width:100%;
    padding:8px;
    margin-top:6px;
    border:1px solid #ddd;
    border-radius:6px;
    box-sizing:border-box;
    text-transform:uppercase;
  }

  .btn{
    display:inline-block;
    padding:8px 10px;
    margin-top:8px;
    border-radius:6px;
    cursor:pointer;
    background:var(--accent);
    color:#fff;
    border:none;
  }

  .preview-wrap{flex:1; max-width:824px;}

  .ticket-canvas{
    width:820px;
    height:1050px;
    background:#fff;
    border:1px solid #ccc;
    position:relative;
    overflow:hidden;
  }

  .ticket-bg{
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    object-fit:contain;
    pointer-events:none;
  }

  .overlay{
    position:absolute;
    pointer-events:none;
    color:#000;
    font-size:15px;
    white-space:pre-wrap;
    text-transform:uppercase;
  }

  #folioOverlay{ right:45px; top:60px; font-weight:700; font-size:16px; }
  #stateCodeOverlay{ right:97px; top:60px; font-size:16px; font-weight:600; }

  #customerNameOverlay{ top:120px; left:17%; transform:translateX(-50%); text-align:center; }
  #rigNameOverlay{ top:120px; left:50%; transform:translateX(-50%); text-align:center; }
  #wellNameOverlay{ top:162px; left:50%; transform:translateX(-50%); text-align:center; }
  #parishOverlay{ top:202px; left:50%; transform:translateX(-50%); text-align:center; }

  #dateOverlay{ top:120px; left:82%; transform:translateX(-50%); text-align:center; }
  #techOverlay{ top:243px; left:83%; transform:translateX(-50%); text-align:center; }

  #serviceTypeOverlay{
    left:143px; right:391px; top:562px;
    font-size:15px; font-weight:400; text-align:left;
  }

  #commentsOverlay{
    top:585px; left:23%; transform:translateX(-50%);
    width:300px; height:180px;
    overflow:hidden;
    font-size:15px;
    line-height:1.8;
  }

  #wcOverlay{ left:35px; top:755px; }
  #aOverlay{ left:35px; top:784px; }
  #dOverlay{ left:35px; top:813px; }
  #rtOverlay{ left:35px; top:832px; }

  @media(max-width:1100px){
    .ticket-canvas{ transform:scale(0.85); transform-origin:top left; }
  }
/* ======== RESPONSIVE PARA CELULARES ======== */
@media (max-width: 768px) {

  body {
    margin: 8px;
    overflow-x: hidden;
  }

  .container {
    flex-direction: column;
    gap: 20px;
  }

  .form {
    width: 100% !important;
    max-height: unset !important;
  }

  .preview-wrap {
    width: 100% !important;
    max-width: 100% !important;
    overflow-x: auto;
  }

  .ticket-canvas {
    transform: scale(0.52);
    transform-origin: top left;
    width: 820px;
    height: 1050px;
    margin-bottom: 30px;
  }
}

/* ===== Modal Responsive Fix ===== */
#trelloModal {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  backdrop-filter:blur(4px);
  z-index:9999;
  overflow:auto;
  padding:20px;
}

#trelloModal .modal-box {
  background:white;
  width:90%;
  max-width:420px;
  margin:auto;
  margin-top:40px;
  padding:15px;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.35);

  /* Para que el contenido nunca se esconda */
  max-height:90vh;
  overflow-y:auto;
}

#trelloModal textarea {
  width:100%;
  height:220px;
  font-size:15px;
  padding:8px;
  text-transform:uppercase;
}

.modal-buttons {
  margin-top: 10px;
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
/* ===== FIX ESPECIAL PARA CELULARES PEQUEÑOS ===== */
@media (max-width: 480px) {
  #trelloModal .modal-box {
    width: 85%;
    max-width: 310px;   /* Antes 420px */
    margin-top: 20px;   /* Más cerca del top */
    padding: 10px;      /* Más compacto */
  }

  #trelloModal textarea {
    height: 160px;      /* Antes 220px */
    font-size: 14px;    /* Más legible en pantallas chicas */
  }
}



</style>
</head>
<body>

<div style="display:flex; gap:12px; align-items:center; margin-bottom:10px;">
  <h3 style="margin:0; text-transform:uppercase;">POWERSAT SERVICE TICKET EDITOR</h3>
<div class="small">Fill out the fields and generate your PDF.</div>

</div>

<div class="container">

<div class="panel form">

    <button id="locBtn" type="button" class="btn">GET GPS LOCATION</button>

    <label>FOLIO</label>
    <input id="folioInput" type="text" maxlength="5" inputmode="numeric" />

    <label>STATE CODE</label>
    <input id="stateCodeInput" type="text" maxlength="3" />

    <label>CUSTOMER NAME</label>
    <input id="customerInput" type="text" />

    <label>RIG NAME</label>
    <input id="rigInput" type="text" />

    <label>WELL NAME</label>
    <input id="wellInput" type="text" />

    <label>PARISH / COUNTY</label>
    <input id="parishInput" type="text" />

    <label>DATE</label>
    <input id="dateInput" type="date" />

    <label>TECHNICIAN</label>
    <input id="techInput" type="text" />

    <label>SERVICE TYPE</label>
    <select id="serviceSelect">
      <option value="">-- SELECT --</option>
      <option>RIG UP</option>
      <option>RIG DOWN</option>
      <option>RIG OUT</option>
      <option>RELEASE</option>
      <option>SERVICE CALL</option>
      <option>INSTALL</option>
      <option>REPAIR</option>
      <option>WARRANTY</option>
    </select>

    <label>COMMENTS (SHORT)</label>
    <select id="predComment">
      <option value="">-- QUICK COMMENT --</option>
      <option>AFTER MOVE</option>
      <option>FOR MOVE</option>
      <option>OFFICE TRAILER</option>
      <option>GENERATOR</option>
      <option>COMM TOWER</option>
      <option>COMM PACKAGES</option>
      <option>TOWER</option>
      <option>PACKAGES</option>
    </select>
    <textarea id="descInput" rows="4"></textarea>

    <label>W/C - $</label>
    <input id="wcInput" type="text" />

    <label>ARRIVAL TIME (A)</label>
    <input id="aInput" type="time" />

    <label>DEPARTURE TIME (D)</label>
    <input id="dInput" type="time" />

    <label>HQ COORDINATES (LAT,LON)</label>
    <input id="hqAddr" type="text" value="32.700957173569805, -103.1492677516" />

    <label>JOB LOCATION (LAT,LON)</label>
    <input id="workAddr" type="text" />

    <label>R/T - MILES</label>
    <input id="rtManual" type="text" maxlength="5" inputmode="numeric" />

    <div style="margin-top:10px;">
      <button id="fillBtn" class="btn">TRELLO / CALENDAR</button>
      <button id="generatePDF" class="btn" style="background:#0a8">GENERATE PDF</button>
      <button id="downloadJSON" class="btn" style="background:#777">EXPORT JSON</button>
    </div>

    <hr />
    <div class="small"><b>UPLOAD FORM IMAGE</b></div>
    <input id="bgInput" type="file" accept="image/*" />
</div>



  <div class="panel preview-wrap">
    <div id="ticketCanvas" class="ticket-canvas">

      <img id="ticketImg" class="ticket-bg" src="" />

      <div id="folioOverlay" class="overlay"></div>
      <div id="stateCodeOverlay" class="overlay"></div>
      <div id="customerNameOverlay" class="overlay"></div>
      <div id="rigNameOverlay" class="overlay"></div>
      <div id="wellNameOverlay" class="overlay"></div>
      <div id="parishOverlay" class="overlay"></div>
      <div id="serviceTypeOverlay" class="overlay"></div>

      <div id="dateOverlay" class="overlay"></div>
      <div id="techOverlay" class="overlay"></div>
      <div id="commentsOverlay" class="overlay"></div>

      <div id="wcOverlay" class="overlay"></div>
      <div id="aOverlay" class="overlay"></div>
      <div id="dOverlay" class="overlay"></div>
      <div id="rtOverlay" class="overlay"></div>
      <div id="companyStampOverlay" class="overlay"></div>

    </div>
  </div>
</div>
<!-- Modal OILFIELD -->
<div id="trelloModal">
  <div class="modal-box">

      <h3 style="margin:5px 0 10px 0; text-transform:uppercase;">OPERATIONS NOTE</h3>

    <textarea id="trelloText"></textarea>


    <div class="modal-buttons">
      <button id="copyTrello" class="btn" style="background:#0a8;">COPY</button>
      <button id="closeModal" class="btn" style="background:#777;">CLOSE</button>

    </div>
  </div>
</div>
<script>
/* Ruta por defecto */
const DEFAULT_BG_PATH = "formatoOriginal.jpeg";

/* Coordenadas aproximadas de HQ para cálculo de millas */
const HQ_COORDS = {
  hobbs: { lat: 32.7020, lon: -103.1390 },
  quail: { lat: 31.9000, lon: -102.3000 }
};

const EARTH_RADIUS_MI = 3958.8;

/* Bind DOM */
const folioInput      = document.getElementById('folioInput');
const stateCodeInput  = document.getElementById('stateCodeInput');
const customerInput   = document.getElementById('customerInput');
const rigInput        = document.getElementById('rigInput');
const wellInput       = document.getElementById('wellInput');
const parishInput     = document.getElementById('parishInput');
const dateInput       = document.getElementById('dateInput');
const techInput       = document.getElementById('techInput');
const serviceSelect   = document.getElementById('serviceSelect');
const predComment     = document.getElementById('predComment');
const descInput       = document.getElementById('descInput');
const wcInput         = document.getElementById('wcInput');
const aInput          = document.getElementById('aInput');
const dInput          = document.getElementById('dInput');

const hqAddr          = document.getElementById('hqAddr');
const workAddr        = document.getElementById('workAddr');
const rtManual        = document.getElementById('rtManual');

const fillBtn         = document.getElementById('fillBtn');
const generatePDF     = document.getElementById('generatePDF');
const downloadJSON    = document.getElementById('downloadJSON');
const bgInput         = document.getElementById('bgInput');
const ticketImg       = document.getElementById('ticketImg');
const locBtn          = document.getElementById('locBtn');

/* Overlays */
const folioOverlay        = document.getElementById('folioOverlay');
const stateCodeOverlay    = document.getElementById('stateCodeOverlay');
const customerNameOverlay = document.getElementById('customerNameOverlay');
const rigNameOverlay      = document.getElementById('rigNameOverlay');
const wellNameOverlay     = document.getElementById('wellNameOverlay');
const parishOverlay       = document.getElementById('parishOverlay');
const dateOverlay         = document.getElementById('dateOverlay');
const techOverlay         = document.getElementById('techOverlay');
const serviceTypeOverlay  = document.getElementById('serviceTypeOverlay');
const commentsOverlay     = document.getElementById('commentsOverlay');

const wcOverlay           = document.getElementById('wcOverlay');
const aOverlay            = document.getElementById('aOverlay');
const dOverlay            = document.getElementById('dOverlay');
const rtOverlay           = document.getElementById('rtOverlay');
const stampOverlay        = document.getElementById('companyStampOverlay');

/* COSTOS AUTO POR SERVICIO */
function updateWCByService() {
  const srv = serviceSelect.value.toUpperCase().trim();
  const map = {
      "INSTALL": "400",
      "REPAIR": "N/C",
      "WARRANTY": "N/C",
      "SERVICE CALL": "N/C",
      "RIG OUT": "350",
      "RIG DOWN": "350",
      "RIG UP": "400",
      "RELEASE": "350"
  };
  if (map[srv] !== undefined) {
      wcInput.value = map[srv];
  }
}

/* Cargar formato original y valores iniciales */
window.addEventListener("DOMContentLoaded", () => {

  ticketImg.src = DEFAULT_BG_PATH;
  ticketImg.style.display = "block";

  const now  = new Date();
  const yyyy = now.getFullYear();
  const mm   = String(now.getMonth() + 1).padStart(2,'0');
  const dd   = String(now.getDate()).padStart(2,'0');
  dateInput.value = `${yyyy}-${mm}-${dd}`;

  techInput.value     = "ULISES RANGEL";
  customerInput.value = "EOG";
  rigInput.value      = "COMPLETIONS";

  hqAddr.value = "32.700957173569805, -103.1492677516";

  const end   = new Date(now.getTime() + 5 * 60000);
  const start = new Date(end.getTime() - 60 * 60000);

  const fmt = d => 
    String(d.getHours()).padStart(2,'0') + ":" +
    String(d.getMinutes()).padStart(2,'0');

  aInput.value = fmt(start);
  dInput.value = fmt(end);
});

/* Acciones al hacer focus */
customerInput.addEventListener('focus', e => e.target.select());
rigInput.addEventListener('focus', e => e.target.select());
techInput.addEventListener('focus', e => e.target.select());

/* Cambio de servicio = actualizar costo */
serviceSelect.addEventListener("change", () => {
    updateWCByService();
    syncOverlays();
});

/* Insertar comentarios rápidos */
predComment.addEventListener("change", () => {
    if (predComment.value) {
        descInput.value = (descInput.value + " " + predComment.value).trim();
        predComment.value = "";
        syncOverlays();
    }
});

/* SOLO NÚMEROS */
function forceDigitsMax(el, maxLen){
  el.value = el.value.replace(/\D/g,'').slice(0, maxLen);
}

folioInput.addEventListener('input', () => forceDigitsMax(folioInput, 5));
rtManual.addEventListener('input', () => forceDigitsMax(rtManual, 5));

rtManual.addEventListener("input", () => {
    rtManual.dataset.autofilled = "false";
});

/* Subir formato */
bgInput.addEventListener('change', e => {
  const f = e.target.files?.[0];
  if (!f) {
    ticketImg.src = DEFAULT_BG_PATH;
    return;
  }
  ticketImg.src = URL.createObjectURL(f);
});

/* Fecha MDY */
function formatDateMDY(v){
  if(!v) return "";
  const p = v.split("-");
  return `${p[1]}-${p[2]}-${p[0]}`;
}

/* Resolver siglas */
function stateToCode(n){
  if(!n) return "";
  const map = {
    "Texas":"TX",
    "New Mexico":"NM",
    "Nuevo México":"NM",
    "Nuevo Leon":"NL",
    "Nuevo León":"NL"
  };
  return map[n] || "";
}

/* Distancia Haversine */
function deg2rad(x){ return x*Math.PI/180; }

function haversineMiles(lat1, lon1, lat2, lon2){
  const dLat = deg2rad(lat2-lat1);
  const dLon = deg2rad(lon2-lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(deg2rad(lat1)) *
    Math.cos(deg2rad(lat2)) *
    Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return EARTH_RADIUS_MI * c;
}

/* Parse lat/lon */
function parseLatLon(str){
  if(!str) return null;
  const m = str.trim().match(/(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)/);
  if(!m) return null;
  return { lat: parseFloat(m[1]), lon: parseFloat(m[3]) };
}

/* Sincronizar overlays */
function syncOverlays(){
  folioOverlay.textContent = folioInput.value || "";
  stateCodeOverlay.textContent = stateCodeInput.value || "";
  customerNameOverlay.textContent = customerInput.value || "";
  rigNameOverlay.textContent = rigInput.value || "";
  wellNameOverlay.textContent = wellInput.value || "";
  parishOverlay.textContent = parishInput.value || "";

  dateOverlay.textContent = dateInput.value ? formatDateMDY(dateInput.value) : "";
  techOverlay.textContent = techInput.value || "";

  serviceTypeOverlay.textContent = serviceSelect.value || "";
  commentsOverlay.textContent = descInput.value || "";

  wcOverlay.textContent = wcInput.value ? `W/C - $${wcInput.value}` : "";
  aOverlay.textContent  = aInput.value  ? `A- ${aInput.value}` : "";
  dOverlay.textContent  = dInput.value  ? `D- ${dInput.value}` : "";
  rtOverlay.textContent = rtManual.value ? `R/T- ${rtManual.value} MILES` : "";
}

/* Calcular R/T */
function computeAndMaybeSetRT(changedByWorkAddr=false){
  const work = parseLatLon(workAddr.value);
  if(!work) return;

  const hq = parseLatLon(hqAddr.value);
  if(!hq) return;

  const milesOneWay = haversineMiles(hq.lat, hq.lon, work.lat, work.lon);
  const ROAD_FACTOR = 1.4;
  const milesRT = Math.round(milesOneWay * ROAD_FACTOR * 2);

  if (changedByWorkAddr) {
    rtManual.dataset.autofilled = "true";
  }

  if (rtManual.dataset.autofilled !== "false") {
    rtManual.value = String(milesRT);
    syncOverlays();
  }
}

/* Eventos blur para actualizar */
[
  folioInput, stateCodeInput, customerInput, rigInput, wellInput, parishInput,
  dateInput, techInput, predComment, descInput,
  wcInput, aInput, dInput, rtManual, workAddr, hqAddr
].forEach(el => el.addEventListener("blur", () => {

  if (el === workAddr) computeAndMaybeSetRT(true);
  if (el === hqAddr) computeAndMaybeSetRT(true);

  syncOverlays();
}));

/* Obtener ubicación */
locBtn.addEventListener("click", () => {
  if (!navigator.geolocation){
    alert("GPS no soportado.");
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos => {

    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    try{
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&addressdetails=1`;
      const resp = await fetch(url);
      const data = await resp.json();

      const addr = data.address || {};
      const state = addr.state || "";
      const county = addr.county || addr.municipality || addr.region || "";

      workAddr.value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      parishInput.value = county;
      stateCodeInput.value = stateToCode(state) || state;

      computeAndMaybeSetRT();
      syncOverlays();

    } catch(e){
      console.error(e);
      alert("No se pudo obtener dirección desde GPS.");
    }

  }, err => alert("No se pudo obtener GPS: " + err.message), {
    enableHighAccuracy:true,
    timeout:10000
  });
});

/* FIN PARTE 1 */
/* Botón: generar texto estilo Trello/Calendar */
fillBtn.addEventListener("click", () => {

  const service = serviceSelect.value || "";
  const desc    = descInput.value || "";
  const jobDesc = `${service} ${desc}`.trim();

  const state = stateCodeInput.value || "";
  const folio = folioInput.value || "";
  const dateMDY = dateInput.value ? formatDateMDY(dateInput.value) : "";

  const cost = wcInput.value ? `W/C - $${wcInput.value}` : "N/C";
  const aTime = aInput.value ? `A- ${aInput.value}` : "";
  const dTime = dInput.value ? `D- ${dInput.value}` : "";
  const rt    = rtManual.value ? `R/T- ${rtManual.value} MILES` : "";
  const tech  = techInput.value || "";

  const block =
`${jobDesc}
${state}-${folio}
${dateMDY}
${cost}
${aTime}
${dTime}
${rt}
${tech}`.trim();

  document.getElementById("trelloText").value = block;
  document.getElementById("trelloModal").style.display = "block";
});

/* Copiar texto */
document.getElementById("copyTrello").addEventListener("click", () => {
  const txt = document.getElementById("trelloText");
  txt.select();
  document.execCommand("copy");
});

/* Cerrar modal */
document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("trelloModal").style.display = "none";
});

/* PDF */
generatePDF.addEventListener("click", async () => {

  syncOverlays();

  const state  = stateCodeInput.value.trim().toUpperCase();
  const folio  = folioInput.value.trim();
  const cust   = customerInput.value.trim().replace(/\s+/g," ");
  const well   = wellInput.value.trim().replace(/\s+/g," ");
  const srv    = serviceSelect.value.trim().replace(/\s+/g," ");

  let desc = descInput.value.trim().split(/\s+/).slice(0,3).join(" ");

  let wcStatus = "NC";
  if (wcInput.value.trim() !== "" && wcInput.value.trim().toUpperCase() !== "N/C") {
    wcStatus = "WC";
  }

  const fileName = `${state}-${folio} ${cust} ${well} ${srv} ${desc} ${wcStatus}`.toUpperCase();

  const area = document.getElementById("ticketCanvas");
  const canvas = await html2canvas(area, { scale:2, useCORS:true });
  const img = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    unit:"px",
    format:[canvas.width, canvas.height]
  });

  pdf.addImage(img,"PNG",0,0,canvas.width,canvas.height);
  pdf.save(`${fileName}.pdf`);
});

/* JSON Export */
downloadJSON.addEventListener("click", () => {

  const data = {
    folio:folioInput.value,
    stateCode:stateCodeInput.value,
    customer:customerInput.value,
    rig:rigInput.value,
    well:wellInput.value,
    parish:parishInput.value,
    date:dateInput.value,
    tech:techInput.value,
    predComment:predComment.value,
    desc:descInput.value,
    wc:wcInput.value,
    a:aInput.value,
    d:dInput.value,
    rt:rtManual.value,
    workAddr:workAddr.value,
    hqAddr:hqAddr.value
  };

  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "ticket.json";
  a.click();

  URL.revokeObjectURL(url);
});

</script>
</body>
</html>
